default_platform(:ios)

platform :ios do
  desc "Build and upload to TestFlight"
  lane :beta do
    # Ensure we have the latest from CocoaPods
    cocoapods(
      podfile: "./ios/Podfile"
    )

    # Increment build number
    increment_build_number(
      xcodeproj: "./ios/BirthdayReminder.xcodeproj"
    )

    # Get certificates and provisioning profiles
    sync_code_signing(
      type: "appstore",
      readonly: is_ci
    )

    # Update Xcode project code signing settings
    update_code_signing_settings(
      use_automatic_signing: false,
      path: "./ios/BirthdayReminder.xcodeproj",
      team_id: ENV["TEAM_ID"],
      bundle_identifier: ENV["APP_IDENTIFIER"],
      profile_name: "match AppStore #{ENV['APP_IDENTIFIER']}",
      code_sign_identity: "iPhone Distribution"
    )

    # Bundle React Native JavaScript and assets
    # This avoids Ruby version conflicts during xcodebuild
    UI.message("ðŸ“¦ Bundling React Native JavaScript for production...")
    sh("cd .. && pnpm react-native bundle --platform ios --dev false --entry-file index.js --bundle-output ios/main.jsbundle --assets-dest ios")

    # Build the app
    # Skip the React Native bundling script since we already bundled above
    # Unset BUNDLE_GEMFILE to avoid CocoaPods scripts trying to use bundler
    ENV.delete('BUNDLE_GEMFILE')
    ENV.delete('BUNDLE_BIN_PATH')
    ENV.delete('RUBYOPT')

    build_app(
      workspace: "./ios/BirthdayReminder.xcworkspace",
      scheme: "BirthdayReminder",
      configuration: "Release",
      export_method: "app-store",
      output_directory: "./build",
      output_name: "BirthdayReminder.ipa",
      clean: true,
      xcargs: "DEVELOPMENT_TEAM=#{ENV['TEAM_ID']} SKIP_BUNDLING=1",
      export_options: {
        method: "app-store",
        teamID: ENV["TEAM_ID"],
        signingStyle: "manual",
        provisioningProfiles: {
          ENV["APP_IDENTIFIER"] => "match AppStore #{ENV['APP_IDENTIFIER']}"
        }
      }
    )

    # Upload to TestFlight
    upload_to_testflight(
      skip_waiting_for_build_processing: true,
      api_key_path: ENV["APP_STORE_CONNECT_API_KEY_PATH"]
    )
  end

  desc "Register new device"
  lane :register_device do
    register_devices(
      devices_file: "./fastlane/devices.txt"
    )
  end

  desc "Sync certificates and provisioning profiles"
  lane :sync_certificates do
    sync_code_signing(
      type: "appstore"
    )
  end
end
